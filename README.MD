## Описание

Файл CDR (Call Data Record) собирается на коммутаторе - оборудовании, обрабатывающем звонки.   
Этот файл содержит следующую обязательную информацию:   
* тип вызова (01 -исходящие, 02 -входящие)   
* номер абонента
* дата и время начала звонка (YYYYMMDDHH24MMSS)   
* дата и время окончания звонка    

Вот пример готовой записи cdr:   
02,79876543221,20230321160455,20230321163211

CDR принимает BRT (Billing Real Time). Получив данные из CDR BRT авторизует абонентов  
оператора "Ромашка", чей баланс больше 0. Для этого BRT связывается с базой клиентов в которой  
есть информация о абоненте: номер, тариф, баланс. Тарифов, как и раньше 3:  
* (06) Безлимит 300: 300 минут -за тарифный период стоят фиксированную сумму - 100р.  
      Каждая последующая минута - 1р.  
* (03) Поминутный: 1 минута разговора -1.5 рубля.  
* (11) Обычный: Входящие - бесплатно, исходящие - первые 100 минут по 0.5р/минута,  
      после по тарифу "поминутный".  

### Важные уточнения:   
* входящие - платные, если не указано обратного;  
* в задании каждая CDR представляет из себя тарифный период, следовательно, в тарифе "безлимит",  
 пользователь, проговоривший менее 300 минут обязан выплатить абонентскую плату.  
* при тарификации абонентов каждая дополнительная секунда разговора засчитывается как минута.  

#### Пример:  
звонок длится 1:11, следовательно, по тарифу "поминутный" пользователь обязан  
заплатить 3 р (по 1.5 за минуту).  

После авторизации BRT генерирует файл CDR+, который содержит уже информацию о тарифе абонента  
и передает его в HRS (High performance rating server). HRS считает сколько денег нужно списать  
со счета абонента, исходя из длительности его разговоров и выбранного тарифа и возвращает данные  
в BRT, который вносит изменения в базу и меняет баланс пользователя на соответствующую сумму.  

Есть CRM система, в которой есть два уровня прав: менеджер и абонент.  

#### Абонент может пополнить счет.  
Endpoint - ../abonent/pay/  
Method - POST  

Request Body   
```json
{  
    "numberPhone": "7123123123",  
    "money": "400"  
}
```

Response Body
```json
{  
    "id": "123124124",  
    "numberPhone": "7123123123",  
    "money": "400"  
}  
```

#### И получить детализацию звонков:  
Endpoint - ../abonent/report/{numberPhone}  
Method - GET  
Arguments – numberPhone  

Response Body  
```json
{
    "numberPhone": "7123123123",  
    "tariffIndex": "03",  
    "payload": [   
        {   
            "callType": "01",  
            "startTime": "2023-02-03 05:55:06",  
            "endTime": "2023-02-03 06:02:49",  
            "duration": "00:07:43",  
            "cost": "5.00"  
        },  
        ...  
        {  
            "callType": "02",  
            "startTime": "2023-10-11 14:00:17",  
            "endTime": "2023-10-11 14:10:19",  
            "duration": "00:10:02",  
            "cost": "5.00"  
        }  
    ],  
    "totalCost": "33.00",  
    "monetaryUnit": "rubles"  
}
```

#### Менеджер может сменить тариф.  
Endpoint - ..manager/changeTariff/  
Method-POST  

Request Body  
```json
{  
    "numberPhone": "7123123123",  
    "tariff_id": "06"  
}  
```

Response Body  
```json
{  
    "id": "123124124",  
    "numberPhone": "7123123123",  
    "tariff_id": "06"  
}  
```

#### Создать нового пользователя  
Endpoint - ..manager/abonent/  
Method - POST  

Request Body  
```json
{  
    "numberPhone": "7123123123",  
    "tariff_id": "06",  
}  
```
Response Body  
```json
{  
    "numberPhone": "7123123123",  
    "tariff_id": "06",  
    "balance" : "0"  
}  
```

#### И выполнять тарификацию.  
Endpoint - ..manager/billing  
Method - PATCH  

Request Body  
```json
{  
    "action" : "run",  
    "year": "2023",  
    "month": "4"  
}
```

Response Body  
```json
{  
    "numbers" : [  
        {  
            "phoneNumber": "7123123123",  
            "balance": "440"  
        },  
        ....  
    ]  
}
```

## Задание

* на основе примера CDR генерировать тестовые данные для проверки корректности работы  
приложения в разных условиях  

* создать и заполнить базу клиентов тестовыми данными (можно использовать стороннее API  
для генерации данных) добавить в базу таблицу с тарифами с возможностью расширяемости,  
т.е. организовать поля таким образом, чтобы легко можно было добавить новый тариф  

* пользуясь Spring и Spring Boot поднять локальный сервер с Tomcat который будет принимать  
и обрабатывать указанные запросы   

## Задание*  

* организовать кэш в системах CDR и BRT который будет хранить необходимые данные для работы.  
В случае изменения значений в базе (например пополнение счета), настроить нотификации  
соответствующим сервисам для автоматического изменеия значений в кэше.  

* организовать таблицу тарифов с возможностью добавить новый тариф:  
    - 82: Тариф Х: Исходящие и входящие звонки абонентам оператора Ромашка - бесплатно.  
        Всем остальным -расчет по тарифу "поминутный".  

* дополнить Swagger документацию. Добавить авторизацию в соответствующие методы  
Описание Swagger`a происходит в соответствии с документацией третьей версии  
https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.0.3.md